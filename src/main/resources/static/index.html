<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Phase1 Philippines</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="p-4">
  <div class="container">
    <h3>Phase1 Philippines Exam</h3>

    <div class="row g-2 align-items-center my-3">
      <div class="col-auto">
        <label for="valueInput" class="col-form-label">Number (required)</label>
      </div>
      <div class="col-auto">
        <input id="valueInput" type="number" min="1" class="form-control" required>
      </div>
      <div class="col-auto">
        <button id="checkBtn" class="btn btn-primary">Check</button>
      </div>
    </div>

    <table class="table table-striped" id="resultsTable">
      <thead>
        <tr>
          <th scope="col">Input</th>
          <th scope="col">Response</th>
          <th scope="col">When</th>
        </tr>
      </thead>
      <tbody>
        <!-- new rows here -->
      </tbody>
    </table>

  </div>

<script>
$(function() {
  const $btn = $('#checkBtn');
  const $input = $('#valueInput');
  const $tbody = $('#resultsTable tbody');

  function renderRow(record) {
    const input = record.inputValue ?? '';
    let responseDisplay = '';
    try {
      const parsed = record.responseJson ? JSON.parse(record.responseJson) : null;
      if (!parsed) {
        responseDisplay = 'No response';
      } else if (Object.keys(parsed).length === 0 || (parsed.a == null && parsed.b == null && parsed.c == null)) {
        responseDisplay = 'No match';
      } else {
        responseDisplay = `A: ${parsed.a}, B: ${parsed.b}, C: ${parsed.c}, AVG: ${parsed.avg}`;
      }
    } catch (e) {
      responseDisplay = record.responseJson || 'invalid json';
    }

    let when = record.createdAt ? new Date(record.createdAt).toLocaleString() : '';

    return `<tr data-id="${record.id}">
      <td>${input}</td>
      <td><pre style="margin:0">${responseDisplay}</pre></td>
      <td>${when}</td>
    </tr>`;
  }

  function fetchRecords() {
    $.ajax({
      url: '/api/records',
      method: 'GET',
      dataType: 'json',
      success: function(records) {
        $tbody.empty();

        if (!Array.isArray(records) || records.length === 0) {
          $tbody.append('<tr><td colspan="3"><em>No records yet</em></td></tr>');
          return;
        }

        records.sort(function(a, b) {
          const da = a.createdAt ? new Date(a.createdAt).getTime() : 0;
          const db = b.createdAt ? new Date(b.createdAt).getTime() : 0;
          return db - da;
        });

        for (const rec of records) {
          $tbody.append(renderRow(rec));
        }
      },
      error: function(xhr) {
        console.error('Failed to fetch records', xhr);
        $tbody.empty();
        $tbody.append('<tr><td colspan="3"><em>Error loading records</em></td></tr>');
      }
    });
  }

  fetchRecords();

  $btn.on('click', function() {
    const val = $input.val();
    if (!val) {
      alert('Please enter a number');
      return;
    }

    $btn.prop('disabled', true).text('Checking...');

    $.ajax({
      url: '/api/check',
      method: 'POST',
      data: { value: val },
      dataType: 'json',
      success: function(data) {
        fetchRecords();
      },
      error: function(xhr) {
        let err = 'Error';
        try { err = xhr.responseText || xhr.statusText || err; } catch(e) {}
        const now = new Date().toLocaleString();
        $tbody.prepend(`<tr><td>${val}</td><td><pre style="margin:0">${err}</pre></td><td>${now}</td></tr>`);
      },
      complete: function() {
        $btn.prop('disabled', false).text('Check');
      }
    });
  });
});
</script>

</body>
</html>
